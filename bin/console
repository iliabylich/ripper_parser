#!/usr/bin/env ruby

require 'bundler/setup'
require 'pry'
require 'ripper_lexer'
require 'stackprof'

Parser::Builders::Default.modernize

def parse(source)
  parser = Parser::Ruby251WithRipperLexer.new
  buffer = Parser::Source::Buffer.new('(eval)')
  buffer.source = source
  parser.parse(buffer)
end

def parse_legacy(source)
  require 'parser/ruby25'
  parser = Parser::Ruby25.new
  buffer = Parser::Source::Buffer.new('(eval)')
  buffer.source = source
  ast = parser.parse(buffer)
  RipperLexer::AstMinimizer.instance.process(ast)
end

GC.disable

if File.exist?('test.rb')
  source = File.read('test.rb')
  StackProf.run(mode: :cpu, out: 'latest.dump') do
    ripper_result = parse(source)
  end

  parser_result = parse_legacy(source)

  puts 'Ripper:'
  pp ripper_result

  puts 'Parser:'
  p parser_result

  puts 'Same:'
  p ripper_result == parser_result
end

Pry.start
